<!DOCTYPE html>
<meta charset="utf-8">
<html>
    <head>
        <link rel="stylesheet" href="css/template.css">
        <script>
            var oldValueMove = 0;
            var isShading = false;
            var numNodes = 8;
        </script>
                        
    </head>

    <body>
        <div class="navbar">
            <label> Shader mode </label> <input id='shader' type="checkbox" onclick="onShading()">
            <label> Animation </label> <input id='animate' type="checkbox" onclick="updateAnimate()">
            <br/>
            <br/>
            <label><b>Camera</b></label><br/>
            <label>Angle&nbsp;</label><input type="range" id="angle" name="camera" min="-360" max="360" step="1" oninput="updateMove()"><br/>
            <label>Zoom&nbsp;</label>
            <button id="button-zoom" onmousedown="updateZoom(1.1)">In</button>
            <button id="button-zoom" onmousedown="updateZoom(0.9)">Out</button>
            <br/><br/><br/>
            <label><b>File Management</b></label><br/><br/>
            <button id = "button-save" onclick="saveData()">Save</button>
            <button id = "button-load" onclick="loadData()">Load</button>
            <br/><br/>
            <button id = "button-tools" onclick="clearCanvas()">Clear Canvas</button>
            <div id="dynamic-parent" hidden></div>
        </div>

        <div class="title">
            ARTICULATED MODEL
        </div>
        <canvas id="glcanvas" width="pixel">
            Oops ... your browser doesn't support the HTML5 canvas element
        </canvas>
    </body>

    <script>
        var vertices = [];
        var objects = [];

        const canvas = document.querySelector('#glcanvas');
        canvas.width = 520;
        canvas.height = 520;

        // Initialize the GL context
        const gl = canvas.getContext('webgl');

        if (!gl) {
            alert('Unable to initialize WebGL. Your browser or machine may not support it.');
        }

        // Vertex shader source code
        var vertCode = `
            attribute vec3 position;
            attribute vec3 normal;
            attribute vec2 texture;
            attribute vec3 color;

            uniform mat4 Pmatrix;
            uniform mat4 Vmatrix;
            uniform mat4 Mmatrix;
            uniform mat4 Nmatrix;

            varying vec3 vLighting;
            varying vec3 vColor;
            varying vec2 vTextCoord;
            varying float vIsTexture;

            // attribute vec3 vert_pos;
            // attribute vec3 vert_tang;
            // attribute vec3 vert_bitang;
            // attribute vec2 vert_uv;

            // uniform mat4 model_mtx;
            // uniform mat4 norm_mtx;

            // varying vec2 frag_uv;
            // varying vec3 ts_light_pos;
            // varying vec3 ts_frag_pos;

            // mat3 transpose(in mat3 inMatrix)
            // {
            //     vec3 i0 = inMatrix[0];
            //     vec3 i1 = inMatrix[1];
            //     vec3 i2 = inMatrix[2];

            //     mat3 outMatrix = mat3(
            //         vec3(i0.x, i1.x, i2.x),
            //         vec3(i0.y, i1.y, i2.y),
            //         vec3(i0.z, i1.z, i2.z)
            //     );

            //     return outMatrix;
            // }

            void main(void) {
                gl_Position = Pmatrix*Vmatrix*Mmatrix*vec4(position, 1.);
                vec3 ambientLight = vec3(0.3, 0.3, 0.3);
                vec3 directionalLightColor = vec3(1, 1, 1);
                vec3 directionalVector = normalize(vec3(0.85, 0.8, 0.75));
                vec4 transformedNormal = Nmatrix*vec4(normal, 1.);
                
                float directional = max(dot(transformedNormal.xyz, directionalVector), 0.0);
                vLighting = ambientLight + (directionalLightColor * directional);
                vColor = color;
                vTextCoord = texture;


                // ts_frag_pos = vec3(model_mtx * vec4(vert_pos, 1.0));
                // vec3 vert_norm = cross(vert_bitang, vert_tang);

                // vec3 t = normalize(mat3(norm_mtx) * vert_tang);
                // vec3 b = normalize(mat3(norm_mtx) * vert_bitang);
                // vec3 n = normalize(mat3(norm_mtx) * vert_norm);
                // mat3 tbn = transpose(mat3(t, b, n));
                
                // vec3 light_pos = vec3(1, 2, 0);
                // ts_light_pos = tbn * light_pos;
                // ts_frag_pos = tbn * ts_frag_pos;
                // frag_uv = vert_uv;
            }
            `;

        // Create a vertex shader object
        var vertShader = gl.createShader(gl.VERTEX_SHADER);
        // Fragment shader source code
        var fragCode = `precision mediump float;
            varying vec3 vColor;
            varying vec3 vLighting;

            varying vec2 vTextCoord;

            uniform float vIsTexture;
            uniform sampler2D uSampler;
            
            // uniform sampler2D tex_norm;
            // uniform sampler2D tex_diffuse;
            // uniform int show_tex;
            // varying vec2 frag_uv;
            // varying vec3 ts_light_pos;
            // varying vec3 ts_frag_pos;
        
            void main(void) {
                vec4 texelColor = texture2D(uSampler, vTextCoord);

                // vec3 light_dir = normalize(ts_light_pos - ts_frag_pos);
                // vec3 albedo = texture2D(tex_diffuse, frag_uv).rgb;
                // if (show_tex == 0) { 
                //     albedo = vec3(1,1,1);
                // }
                // vec3 ambient = 0.3 * albedo;

                if(vIsTexture == 1.0){
                    gl_FragColor = vec4(texelColor.rgb *vLighting, 1.);
                } 
                else if(vIsTexture == 0.0){
                    gl_FragColor = vec4(vColor.rgb *vLighting,  1.);
                } 
                // else if (vIsTexture == 2){
                //     vec3 norm = normalize(texture2D(tex_norm, frag_uv).rgb * 2.0 - 1.0);
                //     float diffuse = max(dot(light_dir, norm), 0.0);
                //     gl_FragColor = vec4(diffuse * albedo + ambient, 1.0);
                // }
            }`;

        // Create fragment shader object
        var fragShader = gl.createShader(gl.FRAGMENT_SHADER);

        // Create a shader program object to store
        var shaderProgram = gl.createProgram();

        function setupShader(){
            // Attach vertex shader source code
            gl.shaderSource(vertShader, vertCode);
            // Compile the vertex shader
            gl.compileShader(vertShader);
            // Attach fragment shader source code
            gl.shaderSource(fragShader, fragCode);
            // Compile the fragment shader
            gl.compileShader(fragShader);
        }

        function setupProgram(){
            // Attach a vertex shader
            gl.attachShader(shaderProgram, vertShader);
            // Attach a fragment shader
            gl.attachShader(shaderProgram, fragShader);
            // Link both the programs
            gl.linkProgram(shaderProgram);
        }

        setupShader();
        setupProgram();

      </script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.1.1/math.js'></script>
        <!-- <script type="text/javascript" src="js/util.js"></script> -->
        <script type="text/javascript" src="js/matrixOp.js"></script>
        <script type="text/javascript" src="js/projection.js"></script>
        <script type="text/javascript" src="js/shading.js"></script>
        <script type="text/javascript" src="js/draw.js"></script>
        <script type="text/javascript" src="js/tree.js"></script>
        <script type="text/javascript" src="js/camera.js"></script>
        <script type="text/javascript" src="js/animate.js"></script>
        <script type="text/javascript" src="js/filemanager.js"></script>
      <!-- <script type="text/javascript" src="js/transformation.js"></script> -->
      <script>
          document.getElementById('angle').value = oldValueMove;
          function onShading(){
              updateShading();
              traverse(partsId["torso1Id"], stack=[]);
          }
      </script>
</html>
